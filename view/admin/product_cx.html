{{include file="layout/admin_header" web_title="查询业务 - 产品列表"/}}
<div id="kt_content_container" class="app-container container-fluid">
    <div class="card">
        <div class="card-header">
            <div class="card-title">
                <div class="d-flex align-items-center position-relative my-1 me-3">
                    <span class="svg-icon svg-icon-1 position-absolute ms-4">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect opacity="0.5" x="17.0365" y="15.1223" width="8.15546" height="2" rx="1" transform="rotate(45 17.0365 15.1223)" fill="currentColor" />
                            <path d="M11 19C6.55556 19 3 15.4444 3 11C3 6.55556 6.55556 3 11 3C15.4444 3 19 6.55556 19 11C19 15.4444 15.4444 19 11 19ZM11 5C7.53333 5 5 7.53333 5 11C5 14.4667 7.53333 17 11 17C14.4667 17 17 14.4667 17 11C17 7.53333 14.4667 5 11 5Z" fill="currentColor" />
                        </svg>
                    </span>
                    <input type="text" data-kt="search" class="form-control form-control-solid w-250px ps-15 search" placeholder="模糊搜索 - 请输入内容"/>
                </div>
            </div>
            <div class="card-toolbar flex-row-fluid justify-content-end gap-5">
                <button type="button" class="btn btn-sm btn-light btn-light-primary" onclick="product_add_modify(0)" data-kt-menu-trigger="click" id="merchant_add_modify">
                    添加产品
                </button>
            </div>
        </div>
        <div class="card-body pb-5">
            <table id="kt_datatable_example_1" class="table align-middle table-row-dashed fs-6 gy-5">
                <thead>
                    <tr class="text-start text-gray-400 fw-bold fs-7 text-uppercase gs-0">
                        <th class="min-w-25px">ID</th>
                        <th class="min-w-100px">产品名称</th>
                        <th class="min-w-100px">产品描述</th>
                        <th class="min-w-100px">产品图标</th>
                        <th class="min-w-100px">状态</th>
                        <th class="min-w-100px">排序</th>
                        <th class="min-w-100px">创建时间</th>
                        <th class="min-w-100px">操作</th>
                    </tr>
                </thead>
                <tbody class="text-gray-600 fw-semibold">
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="bg-body" data-kt-drawer="true" data-kt-drawer-name="activities" data-kt-drawer-activate="true" data-kt-drawer-overlay="true" data-kt-drawer-width="{default:'300px', 'lg': '500px'}" data-kt-drawer-direction="end" data-kt-drawer-toggle="#merchant_add_modify" data-kt-drawer-close="#kt_activities_close">
    <div class="card w-100 shadow-none border-0 rounded-0">
        <div class="card-header">
            <h3 class="card-title fw-bold text-dark merchant_name"></h3>
            <div class="card-toolbar">
                <button type="button" class="btn btn-sm btn-icon btn-active-light-primary me-n5" id="kt_activities_close">
                    <span class="svg-icon svg-icon-1">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect opacity="0.5" x="6" y="17.3137" width="16" height="2" rx="1" transform="rotate(-45 6 17.3137)" fill="currentColor" />
                            <rect x="7.41422" y="6" width="16" height="2" rx="1" transform="rotate(45 7.41422 6)" fill="currentColor" />
                        </svg>
                    </span>
                </button>
            </div>
        </div>
        <div class="card-body scroll-y">
            <input type="hidden" id="pid">
            <div class="d-flex fs-6 fw-semibold align-items-center mb-6">
                <div class="bullet w-8px h-6px rounded-2 bg-primary me-3"></div>
                <div class="fs-6 fw-semibold text-gray-400 flex-shrink-0">基础信息配置</div>
                <div class="separator separator-dashed min-w-10px flex-grow-1 mx-2"></div>
            </div>
            <div class="fv-row mb-6">
                <label class="required form-label">产品名称</label>
                <input type="text" id="name" class="form-control form-control-solid" placeholder="请输入产品名称">
            </div>
            <div class="fv-row mb-6">
                <label class="required form-label">产品描述</label>
                <textarea type="text" id="describe" placeholder="请输入产品描述" class="form-control form-control-solid" rows="5"></textarea>
            </div>
            <div class="fv-row mb-6">
                <label class="required form-label">查询价格</label>
                <input type="text" id="quiry_price" class="form-control form-control-solid" placeholder="请输入查询价格">
            </div>
            <div class="fv-row mb-6">
                <label class="required form-label">分佣比例</label>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">一级：</span>
                            <input type="text" id="kickback_rtion_1" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">二级：</span>
                            <input type="text" id="kickback_rtion_2" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">三级：</span>
                            <input type="text" id="kickback_rtion_3" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">四级：</span>
                            <input type="text" id="kickback_rtion_4" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">五级：</span>
                            <input type="text" id="kickback_rtion_5" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">六级：</span>
                            <input type="text" id="kickback_rtion_6" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">七级：</span>
                            <input type="text" id="kickback_rtion_7" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">八级：</span>
                            <input type="text" id="kickback_rtion_8" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">九级：</span>
                            <input type="text" id="kickback_rtion_9" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <span class="input-group-text">十级：</span>
                            <input type="text" id="kickback_rtion_10" class="form-control" placeholder="请输入比例">
                            <span class="input-group-text">%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-footer py-5 text-center">
            <button type="button" class="btn btn-sm btn-primary w-100 button_name" onclick="add_modify()"></button>
        </div>
    </div>
</div>
{{include file="layout/admin_footer"/}}
<script src="__ADMIN__/plugins/custom/formrepeater/formrepeater.bundle.js"></script>

<script type="text/javascript">
    var KTDatatablesServerSide = function () {
        var table;
        var dt;
        var filterPayment;
        var initDatatable = function () {
            dt = $("#kt_datatable_example_1").DataTable({
                searchDelay: 500,
                processing: true,
                serverSide: true,
                order: [[6, 'desc']],
                stateSave: true,
                ajax: {
                    url: "{{:getConfig('backstage_entrance')}}/product_list?type=2",
                },
                columns: [
                    { data: 'id' },
                    { data: 'name' },
                    { data: 'describe' },
                    { data: 'image' },
                    { data: null },
                    { data: null },
                    { data: 'create_time' },
                    { data: null },
                ],
                columnDefs: [
                    {
                        targets: 0,
                        orderable: false,
                    },
                    {
                        targets: 1,
                        orderable: false,
                    },
                    {
                        targets: 2,
                        orderable: false,
                    },
                    {
                        targets: 3,
                        orderable: false,
                        render: function (image) {
                            return `
                            <div class="cursor-pointer symbol symbol-35px" data-kt-menu-trigger="{default: 'click', lg: 'hover'}" data-kt-menu-attach="parent" data-kt-menu-placement="bottom-end">
                                <img src="${image||'__ADMIN__/media/avatars/blank.png'}" class="rounded-3" alt="user">
                            </div>`;
                        },
                    },
                    {
                        targets: 4,
                        orderable: false,
                        render: function (data, type, row) {
                            return `
                                <div class="card-toolbar">
                                    <label class="form-check form-switch form-switch-sm form-check-custom form-check-solid">
                                        <input class="form-check-input" type="checkbox" ${row.status ? 'checked="checked"' : '5'}  onclick="status_switch(${row.id})"/>
                                    </label>
                                </div>`;
                        },
                    },
                    {
                        targets: 5,
                        orderable: false,
                        render: function (data, type, row) {
                            return `<input type="text" class="form-control form-control-transparent w-80px" style="padding: 0rem;" placeholder="点击编辑" value="${row.sort}" id="sort_${row.id}" onblur="sort(${row.id});">`;
                        },
                    },
                    {
                        targets: -1,
                        orderable: false,
                        className: 'text-end',
                        render: function (data, type, row) {
                            return `
                            <a href="#" class="btn btn-light btn-active-light-primary btn-sm" data-kt-menu-trigger="click" data-kt-menu-placement="bottom-end">更多操作
                                <span class="svg-icon svg-icon-5 m-0">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M11.4343 12.7344L7.25 8.55005C6.83579 8.13583 6.16421 8.13584 5.75 8.55005C5.33579 8.96426 5.33579 9.63583 5.75 10.05L11.2929 15.5929C11.6834 15.9835 12.3166 15.9835 12.7071 15.5929L18.25 10.05C18.6642 9.63584 18.6642 8.96426 18.25 8.55005C17.8358 8.13584 17.1642 8.13584 16.75 8.55005L12.5657 12.7344C12.2533 13.0468 11.7467 13.0468 11.4343 12.7344Z" fill="currentColor"></path>
                                    </svg>
                                </span>
                            </a>
                            <div class="menu menu-sub menu-sub-dropdown menu-column menu-rounded menu-gray-600 menu-state-bg-light-primary fw-semibold fs-7 w-125px py-4" data-kt-menu="true">
                                <div class="menu-item px-3">
                                    <a class="menu-link" onclick="product_add_modify(1, ${row.id})" data-kt-menu-trigger="click" id="merchant_add_modify">修改信息</a>
                                    <a class="menu-link" onclick="del(${row.id})">删除产品</a>
                                </div>
                            </div>`;
                        },
                    }
                ],
            });
            table = dt.$;
            dt.on('draw', function () {
                KTMenu.createInstances();
            });
        }
        
        var search = function () {
            const filterSearch = document.querySelector('[data-kt="search"]');
            filterSearch.addEventListener('keyup', function (e) {
                dt.search(e.target.value).draw();
            });
        }
        var getSavedSearchContent = function () {
            var state = dt.state.loaded();
            $(".search").val(state.search.search);
        };
        return {
            init: function (id) {
                initDatatable();
                search();
                getSavedSearchContent();
            }
        }
    }();
    KTUtil.onDOMContentLoaded(function () {
        KTDatatablesServerSide.init();
    });

    
    function product_add_modify(type, id) {
        if(type == 1){
            $.ajax({
                url: "{{:getConfig('backstage_entrance')}}/product_post/info",
                method: 'POST',
                data: {
                    id: id,
                },
                dataType: 'json',
                success: function(res) {
                    if (res.code === 200) {
                        $("#pid").val(res.data.id);
                        $("#name").val(res.data.name);
                        $("#describe").val(res.data.describe);
                        $("#quiry_price").val(res.data.quiry_price);
                        $("#kickback_rtion_1").val(res.data.kickback_rtion_1);
                        $("#kickback_rtion_2").val(res.data.kickback_rtion_2);
                        $("#kickback_rtion_3").val(res.data.kickback_rtion_3);
                        $("#kickback_rtion_4").val(res.data.kickback_rtion_4);
                        $("#kickback_rtion_5").val(res.data.kickback_rtion_5);
                        $("#kickback_rtion_6").val(res.data.kickback_rtion_6);
                        $("#kickback_rtion_7").val(res.data.kickback_rtion_7);
                        $("#kickback_rtion_8").val(res.data.kickback_rtion_8);
                        $("#kickback_rtion_9").val(res.data.kickback_rtion_9);
                        $("#kickback_rtion_10").val(res.data.kickback_rtion_10);
                        $(".button_name").html('确认修改');
                        $(".merchant_name").html('修改产品');
                    } else {
                        toastr.error(
                            res.message,
                            {closeButton :!0, timeOut : "3000"}
                        );
                    }
                }
            });
        }else if(type == 0){
            $("#name").val('');
            $("#describe").val('');
            $("#quiry_price").val('');
            $("#kickback_rtion_1").val('');
            $("#kickback_rtion_2").val('');
            $("#kickback_rtion_3").val('');
            $("#kickback_rtion_4").val('');
            $("#kickback_rtion_5").val('');
            $("#kickback_rtion_6").val('');
            $("#kickback_rtion_7").val('');
            $("#kickback_rtion_8").val('');
            $("#kickback_rtion_9").val('');
            $("#kickback_rtion_10").val('');
            $(".button_name").html('确认添加');
            $(".merchant_name").html('添加产品');
        }
    }
    

    function add_modify() {
        $.ajax({
            url: "{{:getConfig('backstage_entrance')}}/product_post/add_modify",
            method: 'POST',
            data: {
                type: 2,
                id: $('#pid').val(),
                name: $('#name').val(),
                describe: $('#describe').val(),
                quiry_price: $('#quiry_price').val(),
                kickback_rtion_1: $('#kickback_rtion_1').val(),
                kickback_rtion_2: $('#kickback_rtion_2').val(),
                kickback_rtion_3: $('#kickback_rtion_3').val(),
                kickback_rtion_4: $('#kickback_rtion_4').val(),
                kickback_rtion_5: $('#kickback_rtion_5').val(),
                kickback_rtion_6: $('#kickback_rtion_6').val(),
                kickback_rtion_7: $('#kickback_rtion_7').val(),
                kickback_rtion_8: $('#kickback_rtion_8').val(),
                kickback_rtion_9: $('#kickback_rtion_9').val(),
                kickback_rtion_10: $('#kickback_rtion_10').val(),
            },
            dataType: 'json',
            success: function(res) {
                if (res.code === 200) {
                    toastr.success(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                    setTimeout(function (){
                        window.location.reload();
                    },1500);
                } else {
                    toastr.error(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                }
            }
        });
    }


    function status_switch(id) {
        $.ajax({
            url: "{{:getConfig('backstage_entrance')}}/product_post/status_switch",
            method: 'POST',
            data: {
                id: id,
            },
            dataType: 'json',
            success: function(res) {
                if (res.code === 200) {
                    toastr.success(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                } else {
                    toastr.error(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                }
            }
        });
    }


    function sort(id) {
        $.ajax({
            url: "{{:getConfig('backstage_entrance')}}/product_post/sort",
            method: 'POST',
            data: {
                id: id,
                sort: $('#sort_'+id).val(),
            },
            dataType: 'json',
            success: function(res) {
                if (res.code === 200) {
                    toastr.success(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                } else {
                    toastr.error(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                }
            }
        });
    }



    function upload(name) {
        var myDropzone = new Dropzone("#" + name, {
            url: "{{:getConfig('backstage_entrance')}}/upload_post",
            paramName: name,
            maxFiles: 1,
            maxFilesize: 5, // MB
            uploadMultiple: false,
            addRemoveLinks: true,
            success: function (file, res) {
                if (res.code === 200) {
                    $('#image').val(res.data);
                    toastr.success(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                } else {
                    toastr.error(
                        res.message,
                        {closeButton :!0, timeOut : "3000"}
                    );
                }
            }
        });
        myDropzone.on("addedfile", function(file) {
            if (myDropzone.files.length > 1) {
            myDropzone.removeFile(myDropzone.files[0]);
            }
        });
    }
    window.onload = function() {
        upload('upload');
    };
</script>